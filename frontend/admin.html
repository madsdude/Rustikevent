<!doctype html>
<html lang="da">
<head>
  <meta name="referrer" content="no-referrer">
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin · Rustik Event</title>
  <link rel="stylesheet" href="/_shared.css"/>
  <style>
    body{visibility:hidden}
    .id-note{font-size:.85rem; opacity:.8;}
    .hidden{display:none}
  </style>
  <script>
  // Gate: require login before loading the UI
  (function(){
    const t = localStorage.getItem('token');
    if(!t){ location.replace('/login.html?redirect=%2Fadmin.html'); }
    else { document.addEventListener('DOMContentLoaded', ()=>{ document.body.style.visibility='visible'; }); }
  })();
  </script>
</head>
<body>
  <nav class="nav container">
    <div class="logo">R<span style="color:var(--neon)">EVENTS</span></div>
    <div class="nav-right">
      <a class="btn" href="/">Forside</a>
      <a class="btn" href="/kalender.html">Kalender</a>
      <button class="btn" onclick="logout()">Log ud</button>
    </div>
  </nav>

  <main class="container">
    <h1>Admin</h1>

    <section class="card" style="padding:1rem">
      <h2>Opret/redigér event</h2>
      <form id="eventForm" onsubmit="upsert(event)">
        <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr))">
          <label class="hidden">ID <input id="id" type="number" value="0" min="0" style="width:100%"></label>
          <label>Titel <input id="title" required style="width:100%"></label>
          <label>Dato <input id="date" type="date" required style="width:100%"></label>
          <label>Døre <input id="doors" placeholder="20:00" style="width:100%"></label>
          <label>Start <input id="start" placeholder="21:00" style="width:100%"></label>
          <label>Pris <input id="price" placeholder="Fri entre / 120,-" style="width:100%"></label>
          <label>Alder <input id="age" placeholder="18+" style="width:100%"></label>
          <label>Facebook URL <input id="facebook_url" placeholder="https://facebook.com/..." style="width:100%"></label>
          <label>Plakat (URL) <input id="poster_url" placeholder="https://...jpg" style="width:100%"></label>
          <label>Tags (komma) <input id="tags" placeholder="live,dj" style="width:100%"></label>
          <label>Status
            <select id="status" style="width:100%">
              <option value="announced">Annonceret</option>
              <option value="soldout">Udsolgt</option>
              <option value="cancelled">Aflyst</option>
            </select>
          </label>
          <label>Highlight
            <select id="highlight" style="width:100%">
              <option value="false">Nej</option>
              <option value="true">Ja</option>
            </select>
          </label>
        </div>
        <p class="id-note">Tip: Tryk <em>Ny</em> for at oprette — ID udfyldes automatisk. Redigér ved at klikke “Redigér” på et eksisterende event.</p>
        <label>Beskrivelse
          <textarea id="description" rows="4" style="width:100%"></textarea>
        </label>
        <div style="display:flex;gap:.6rem;margin-top:.6rem;flex-wrap:wrap">
          <button class="btn" type="submit">Gem</button>
          <button class="btn" type="button" onclick="clearForm()">Ny</button>
          <button class="btn" type="button" onclick="del()">Slet</button>
        </div>
      </form>
      <div id="msg" style="margin-top:.6rem; opacity:.9"></div>
    </section>

    <section style="margin-top:1rem">
      <h2>Alle events</h2>
      <div id="list" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(320px,1fr))"></div>
    </section>
  </main>

<script>
function logout(){ localStorage.removeItem('token'); location.replace('/login.html'); }
const S = { get token(){ return localStorage.getItem('token')||'' }, };
function authHeaders(){ return S.token ? {'Authorization':'Bearer '+S.token, 'Content-Type':'application/json'} : {'Content-Type':'application/json'}; }
function clearForm(){ document.getElementById('eventForm').reset(); document.getElementById('id').value=0; setMsg(''); }
function setMsg(t, ok){ const el=document.getElementById('msg'); el.textContent=t||''; el.style.color = ok?'#a7f3d0':'#ff9aa2'; }

function fill(e){
  for (const k of Object.keys(e)){
    const el=document.getElementById(k);
    if(!el) continue;
    if(k==='tags') el.value=(e.tags||''); else if(k==='highlight') el.value=String(e.highlight); else el.value = e[k] ?? '';
  }
  document.getElementById('id').value = e.id || 0;
}

async function safeJSON(r){
  if(!r.ok) return null;
  const ct = r.headers.get('content-type')||'';
  if(!ct.includes('application/json')) return null;
  try { return await r.json(); } catch { return null; }
}

async function load(){
  const r = await fetch('/api/events');
  const data = await safeJSON(r);
  if(!data){ setMsg('Kunne ikke hente events (server svarer ikke).'); return; }
  const el=document.getElementById('list');
  el.innerHTML = data.map(e=>`
    <article class="card">
      ${e.poster_url?`<img src="${e.poster_url}" alt="" referrerpolicy="no-referrer" onerror="this.onerror=null;this.src='/img/placeholder.jpg'">`:''}
      <div style="padding:1rem">
        <h3>${e.title}</h3>
        <p style="opacity:.8">${e.date}${e.start?` · kl. ${e.start}`:''}</p>
        <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
          <button class="btn" onclick='fill(${JSON.stringify(e)})'>Redigér</button>
        </div>
      </div>
    </article>`).join('');
  setMsg('');
}

async function upsert(ev){
  ev.preventDefault();
  const body = {
    id: Number(document.getElementById('id').value||0),
    title: document.getElementById('title').value,
    date: document.getElementById('date').value,
    doors: document.getElementById('doors').value,
    start: document.getElementById('start').value,
    price: document.getElementById('price').value,
    age: document.getElementById('age').value||'18+',
    location: 'Rustik Event, Randers',
    poster_url: document.getElementById('poster_url').value,
    facebook_url: document.getElementById('facebook_url').value,
    tags: document.getElementById('tags').value,
    status: document.getElementById('status').value,
    highlight: document.getElementById('highlight').value==='true',
    description: document.getElementById('description').value
  };
  const headers = authHeaders();
  let method = (body.id && body.id!==0) ? 'PUT' : 'POST';
  let url = method==='PUT' ? `/api/events/${body.id}` : '/api/events';
  let r = await fetch(url, {method, headers, body: JSON.stringify(body)});

  // auto-fallback: hvis PUT rammer 404, så prøv POST (ny oprettelse)
  if(r.status===404 && method==='PUT'){
    body.id = 0;
    r = await fetch('/api/events', {method:'POST', headers, body: JSON.stringify(body)});
  }
  if(r.status===401) return location.replace('/login.html?redirect=%2Fadmin.html');
  if(!r.ok){ setMsg('Gem fejlede ('+r.status+').', false); return; }

  clearForm();
  await load();
  setMsg('Gemt ✔', true);
}

async function del(){
  const id = Number(document.getElementById('id').value||0);
  if(!id) return alert('Vælg et event med ID');
  if(!confirm('Slet event #' + id + '?')) return;
  const r = await fetch(`/api/events/${id}`, {method:'DELETE', headers: authHeaders()});
  if(r.status===401) return location.replace('/login.html?redirect=%2Fadmin.html');
  if(!r.ok){ setMsg('Slet fejlede ('+r.status+').', false); return; }
  clearForm();
  await load();
  setMsg('Slettet ✔', true);
}
load();
</script>
</body>
</html>
