<!doctype html>
<html lang="da">
<head>
  <meta name="referrer" content="no-referrer">
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin · Rustik Event</title>
  <link rel="stylesheet" href="/_shared.css"/>
  <style>
    body{visibility:hidden}
    .id-note{font-size:.85rem; opacity:.8;}
    .hidden{display:none}
    .card img{width:100%; height:auto; display:block;}
    .grid{display:grid; gap:1rem;}
  </style>
  <script>
  // Gate: kræv login før UI vises
  (function(){
    const t = localStorage.getItem('token');
    if(!t){ location.replace('/login.html?redirect=%2Fadmin.html'); }
    else { document.addEventListener('DOMContentLoaded', ()=>{ document.body.style.visibility='visible'; }); }
  })();
  </script>
</head>
<body>
  <nav class="nav container">
    <div class="logo">R<span style="color:var(--neon)">EVENTS</span></div>
    <div class="nav-right">
      <a class="btn" href="/">Forside</a>
      <a class="btn" href="/kalender.html">Kalender</a>
      <button class="btn" onclick="logout()">Log ud</button>
    </div>
  </nav>

  <main class="container">
    <h1>Admin</h1>

    <section class="card" style="padding:1rem">
      <h2>Opret/redigér event</h2>
      <form id="eventForm">
        <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr))">
          <label class="hidden">ID <input id="id" type="number" value="0" min="0" style="width:100%"></label>
          <label>Titel <input id="title" required style="width:100%"></label>
          <label>Dato <input id="date" type="date" required style="width:100%"></label>
          <label>Døre <input id="doors" placeholder="20:00" style="width:100%"></label>
          <label>Start <input id="start" placeholder="21:00" style="width:100%"></label>
          <label>Pris <input id="price" placeholder="Fri entre / 120,-" style="width:100%"></label>
          <label>Alder <input id="age" placeholder="18+" style="width:100%"></label>
          <label>Facebook URL <input id="facebook_url" placeholder="https://facebook.com/..." style="width:100%"></label>
          <label>Plakat (URL) <input id="poster_url" placeholder="https://...jpg" style="width:100%"></label>
          <label>Tags (komma) <input id="tags" placeholder="live,dj" style="width:100%"></label>
          <label>Status
            <select id="status" style="width:100%">
              <option value="announced">Annonceret</option>
              <option value="soldout">Udsolgt</option>
              <option value="cancelled">Aflyst</option>
            </select>
          </label>
          <label>Highlight
            <select id="highlight" style="width:100%">
              <option value="false">Nej</option>
              <option value="true">Ja</option>
            </select>
          </label>
        </div>
        <p class="id-note">Tip: Tryk <em>Ny</em> for at oprette — ID udfyldes automatisk. Redigér ved at klikke “Redigér” på et eksisterende event.</p>
        <label>Beskrivelse
          <textarea id="description" rows="4" style="width:100%"></textarea>
        </label>
        <div style="display:flex;gap:.6rem;margin-top:.6rem;flex-wrap:wrap">
          <button class="btn" type="submit">Gem</button>
          <button class="btn" type="button" id="btnNew">Ny</button>
          <button class="btn" type="button" id="btnDelete">Slet</button>
        </div>
      </form>
      <div id="msg" style="margin-top:.6rem; opacity:.9"></div>
    </section>

    <section style="margin-top:1rem">
      <h2>Alle events</h2>
      <div id="list" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(320px,1fr))"></div>
    </section>
  </main>

<script>
const API = '/api';

function logout(){ localStorage.removeItem('token'); location.replace('/login.html'); }

const S = {
  get token(){ return localStorage.getItem('token')||'' },
};

function authHeaders(json=true){
  const h = {};
  if (S.token) h['Authorization'] = 'Bearer ' + S.token;
  if (json) h['Content-Type'] = 'application/json';
  return h;
}

function setMsg(t, ok){
  const el=document.getElementById('msg');
  el.textContent = t || '';
  el.style.color = ok ? '#a7f3d0' : '#ff9aa2';
}

function clearForm(){
  document.getElementById('eventForm').reset();
  document.getElementById('id').value = 0;
  setMsg('');
}

function fill(e){
  // Udfyld formularen med et event-objekt
  const map = [
    'id','title','date','doors','start','price','age','facebook_url',
    'poster_url','tags','status','description'
  ];
  for (const k of map){
    const el = document.getElementById(k);
    if (!el) continue;
    el.value = (e[k] ?? '');
  }
  document.getElementById('location')?.value = e.location || 'Rustik Event, Randers';
  document.getElementById('highlight').value = String(!!e.highlight);
}

async function safeJSON(r){
  const ct = r.headers.get('content-type')||'';
  if (!ct.includes('application/json')) return null;
  try { return await r.json(); } catch { return null; }
}

function posterImg(url, alt=''){
  if(!url) return '';
  return `<img src="${url}" alt="${alt.replace(/"/g,'&quot;')}" loading="lazy" referrerpolicy="no-referrer"
            onerror="this.onerror=null;this.src='/img/placeholder.jpg'">`;
}

async function load(){
  try{
    const r = await fetch(`${API}/events`);
    if (r.status === 401) { return location.replace('/login.html?redirect=%2Fadmin.html'); }
    const data = await safeJSON(r);
    if(!r.ok || !Array.isArray(data)){ setMsg('Kunne ikke hente events ('+r.status+').'); return; }

    const el=document.getElementById('list');
    el.innerHTML = data.map(e=>`
      <article class="card">
        ${posterImg(e.poster_url, e.title || '')}
        <div style="padding:1rem">
          <h3>${e.title || '(Uden titel)'}</h3>
          <p style="opacity:.8">${e.date || ''}${e.start?` · kl. ${e.start}`:''}</p>
          <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
            <button class="btn edit-btn" data-id="${e.id}">Redigér</button>
            <button class="btn danger del-btn" data-id="${e.id}">Slet</button>
          </div>
        </div>
      </article>
    `).join('');

  }catch(err){
    console.error(err);
    setMsg('Netværksfejl ved hentning af events.');
  }
}

// Centralt API-kald m. auth + fejltekst
async function api(path, opts={}){
  const res = await fetch(`${API}${path}`, {
    ...opts,
    headers: {...authHeaders(opts?.body !== undefined), ...(opts.headers||{})}
  });
  if (res.status === 401) {
    // Token udløbet eller mangler
    location.replace('/login.html?redirect=%2Fadmin.html');
    return res;
  }
  return res;
}

// GEM (create/update)
async function upsert(ev){
  ev.preventDefault();

  const body = {
    id: Number(document.getElementById('id').value||0),
    title: document.getElementById('title').value.trim(),
    date: document.getElementById('date').value,
    doors: document.getElementById('doors').value,
    start: document.getElementById('start').value,
    price: document.getElementById('price').value,
    age: document.getElementById('age').value || '18+',
    location: 'Rustik Event, Randers',
    poster_url: document.getElementById('poster_url').value,
    facebook_url: document.getElementById('facebook_url').value,
    tags: document.getElementById('tags').value,
    status: document.getElementById('status').value,
    highlight: document.getElementById('highlight').value === 'true',
    description: document.getElementById('description').value
  };

  let method = (body.id && body.id!==0) ? 'PUT' : 'POST';
  let url = (method==='PUT') ? `/events/${body.id}` : `/events`;

  try{
    let r = await api(url, { method, body: JSON.stringify(body) });

    // fallback: hvis PUT rammer 404 (fx slettet mellem tid), så POST som ny
    if (r.status === 404 && method === 'PUT') {
      body.id = 0;
      r = await api('/events', { method:'POST', body: JSON.stringify(body) });
    }

    if (!r.ok){
      const txt = await r.text().catch(()=> '');
      setMsg(`Gem fejlede (${r.status}) ${txt ? '– ' + txt : ''}`, false);
      return;
    }

    clearForm();
    await load();
    setMsg('Gemt ✔', true);
  }catch(err){
    console.error(err);
    setMsg('Gem fejlede pga. netværksfejl.', false);
  }
}

// SLET
async function del(idFromBtn){
  const id = Number(idFromBtn ?? document.getElementById('id').value || 0);
  if(!id){ alert('Vælg et event med ID'); return; }
  if(!confirm('Slet event #' + id + '?')) return;

  try{
    const r = await api(`/events/${id}`, { method:'DELETE' });

    if (!r.ok){
      const txt = await r.text().catch(()=> '');
      setMsg(`Slet fejlede (${r.status}) ${txt ? '– ' + txt : ''}`, false);
      return;
    }

    clearForm();
    await load();
    setMsg('Slettet ✔', true);
  }catch(err){
    console.error(err);
    setMsg('Sletning fejlede pga. netværksfejl.', false);
  }
}

// Event listeners
document.getElementById('eventForm').addEventListener('submit', upsert);
document.getElementById('btnNew').addEventListener('click', clearForm);
document.getElementById('btnDelete').addEventListener('click', ()=>del());

// Delegerede knapper i listen (Redigér/Slet)
document.getElementById('list').addEventListener('click', (ev)=>{
  const btn = ev.target.closest('button');
  if (!btn) return;
  const id = Number(btn.dataset.id || 0);
  if (!id) return;

  if (btn.classList.contains('edit-btn')) {
    // hent event fra API (sikkert hvis data kan have specialtegn)
    fetch(`${API}/events`)
      .then(r => r.json())
      .then(arr => {
        const e = (arr||[]).find(x => Number(x.id) === id);
        if (e) fill(e);
      });
  } else if (btn.classList.contains('del-btn')) {
    del(id);
  }
});

// Init
load();
</script>
</body>
</html>
